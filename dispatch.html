<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>DespachoPharma | Despacho</title>

  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">

  <style>
    :root{
      --bg:#f8fafc; --card:#fff; --border:#e2e8f0; --text:#0f172a;
    }
    body{ background:var(--bg); color:var(--text); }
    .app-card{
      background:var(--card); border:1px solid var(--border); border-radius:16px;
      box-shadow: 0 6px 20px rgba(15,23,42,.06);
    }
    .brand-dot{ width:10px;height:10px;border-radius:999px;background:#3b82f6;display:inline-block;margin-right:8px; }
    .mono{ font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono","Courier New", monospace; }
    .table td,.table th{ vertical-align:middle; }
    .kbd-hint{ border:1px solid var(--border); border-radius:10px; padding:.15rem .45rem; background:#fff; }
    .soft{ color:#475569; }
  </style>
</head>

<body>
  <nav class="navbar bg-white border-bottom">
    <div class="container">
      <a class="navbar-brand d-flex align-items-center" href="history.html">
        <span class="brand-dot"></span>
        <span class="fw-semibold">DespachoPharma</span>
      </a>

      <div class="ms-auto d-flex align-items-center gap-2">
        <a class="btn btn-outline-secondary btn-sm" href="history.html">Histórico</a>
        <span class="badge text-bg-light border">
          <span class="text-muted">Despacho:</span> <span id="nav_user" class="ms-1 fw-semibold">—</span>
        </span>
        <button id="btn_logout" class="btn btn-outline-secondary btn-sm">Salir</button>
      </div>
    </div>
  </nav>

  <main class="container py-4">
    <div class="row g-3">
      <!-- Left: capture -->
      <div class="col-12 col-lg-5">
        <div class="app-card p-3">
          <div class="d-flex justify-content-between align-items-start">
            <div>
              <div class="fw-semibold">Nuevo despacho</div>
              <div class="text-muted small">Escanea barcode + cantidad + expediente, luego confirma.</div>
            </div>
            <div class="text-end small soft">
              <div><span class="kbd-hint mono">Enter</span> buscar/agregar</div>
            </div>
          </div>

          <div id="alert_main" class="alert alert-danger d-none mt-3 mb-0"></div>
          <div id="alert_ok" class="alert alert-success d-none mt-3 mb-0"></div>

          <div class="mt-3">
            <label class="form-label" for="expediente">Expediente (código paciente)</label>
            <input id="expediente" class="form-control mono" inputmode="numeric" autocomplete="off" placeholder="Ej: 123456" />
            <div class="form-text">Debe ser numérico. (No bloquea si no existe, MVP).</div>
          </div>

          <div class="row g-2 mt-2">
            <div class="col-8">
              <label class="form-label" for="barcode">Barcode</label>
              <input id="barcode" class="form-control mono" autocomplete="off" placeholder="Escanea aquí…" />
            </div>
            <div class="col-4">
              <label class="form-label" for="qty">Cant.</label>
              <input id="qty" class="form-control mono" inputmode="numeric" autocomplete="off" value="1" />
            </div>
          </div>

          <div class="mt-2 d-flex align-items-center justify-content-between">
            <div class="small">
              <span class="text-muted">Producto:</span>
              <span id="lookup_name" class="fw-semibold ms-1">—</span>
              <span id="lookup_state" class="ms-2"></span>
            </div>
            <div class="d-flex gap-2">
              <button id="btn_add" class="btn btn-primary btn-sm" disabled>
                <span id="btn_add_text">Agregar</span>
                <span id="btn_add_spinner" class="spinner-border spinner-border-sm ms-2 d-none"></span>
              </button>
              <button id="btn_clear" class="btn btn-outline-secondary btn-sm">Limpiar</button>
            </div>
          </div>

          <hr class="my-3">

          <div class="d-flex justify-content-between">
            <div class="small text-muted">Items: <span id="items_count" class="fw-semibold text-dark">0</span></div>
            <div class="small text-muted">Unidades: <span id="units_total" class="fw-semibold text-dark">0</span></div>
          </div>

          <div class="d-grid mt-3">
            <button id="btn_confirm" class="btn btn-success" disabled>
              <span id="btn_confirm_text">Confirmar despacho</span>
              <span id="btn_confirm_spinner" class="spinner-border spinner-border-sm ms-2 d-none"></span>
            </button>
          </div>

          <div class="small text-muted mt-3">Sesión: se cierra tras 30 min sin uso.</div>
        </div>
      </div>

      <!-- Right: cart -->
      <div class="col-12 col-lg-7">
        <div class="app-card p-3">
          <div class="fw-semibold">Carrito (validación antes de confirmar)</div>
          <div class="text-muted small">Puedes eliminar líneas antes de confirmar.</div>

          <div id="alert_cart" class="alert alert-danger d-none mt-3 mb-0"></div>

          <div class="table-responsive mt-3">
            <table class="table table-sm">
              <thead class="table-light">
                <tr>
                  <th style="width:18%">Cant.</th>
                  <th style="width:52%">Producto</th>
                  <th style="width:20%">Barcode</th>
                  <th style="width:10%" class="text-end">Acción</th>
                </tr>
              </thead>
              <tbody id="tbody">
                <tr><td colspan="4" class="text-center text-muted py-4">Escanea un barcode para iniciar.</td></tr>
              </tbody>
            </table>
          </div>

        </div>
      </div>
    </div>
  </main>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>

  <script>
    /***********************
     * CONFIG
     ***********************/
    const SUPABASE_URL = "https://rewdmcyqxyzcoeiikoow.supabase.co";
    const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InJld2RtY3lxeHl6Y29laWlrb293Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzEwMDcxMDMsImV4cCI6MjA4NjU4MzEwM30.vRkCRFYez3zeL67Ik_niDrPu9wGt53gEqE6LLf_SUHE";

    const ROUTES = { login:"index.html", history:"history.html", catalog:"catalog.html", cashier:"cashier.html" };

    // RPCs existentes (de tu backend)
    const RPC = {
      touch: "rpc_session_touch",
      logout: "rpc_logout",
      pharmaLookup: "rpc_pharma_lookup",        // <-- lookup en pharma_catalog
      dispatchCreate: "rpc_dispatch_start",     // <-- crea header
      dispatchAddItem: "rpc_dispatch_add_item",  // <-- agrega item
      dispatchConfirm: "rpc_dispatch_confirm"    // <-- confirma (genera delivery_no)
    };

    /***********************
     * Helpers
     ***********************/
    const el = (id) => document.getElementById(id);
    const IDLE_MS = 30 * 60 * 1000;

    function showAlert(id,msg){ const a=el(id); a.textContent=msg; a.classList.remove("d-none"); }
    function hideAlert(id){ const a=el(id); a.textContent=""; a.classList.add("d-none"); }

    function setLastActivity(){ localStorage.setItem("dp_last_activity", new Date().toISOString()); }
    function getSession(){
      return {
        token: localStorage.getItem("dp_session_token")||"",
        role: (localStorage.getItem("dp_role")||"").toLowerCase(),
        name: localStorage.getItem("dp_display_name")||""
      };
    }
    function esc(s){ return String(s??"").replace(/[&<>"']/g,m=>({ "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#039;" }[m])); }
    function btnLoad(btnId, textId, spinId, on, tOn, tOff){
      el(btnId).disabled = on;
      el(spinId).classList.toggle("d-none", !on);
      el(textId).textContent = on ? tOn : tOff;
    }
    function normalizeDigits(v){ return String(v||"").trim().replace(/\D/g,""); }

    async function callRpc(fn, body){
      const res = await fetch(`${SUPABASE_URL}/rest/v1/rpc/${fn}`, {
        method:"POST",
        headers:{
          "Content-Type":"application/json",
          "apikey": SUPABASE_ANON_KEY,
          "Authorization": `Bearer ${SUPABASE_ANON_KEY}`
        },
        body: JSON.stringify(body||{})
      });
      const text = await res.text();
      let data=null; try{ data = text ? JSON.parse(text) : null; }catch{ data=null; }
      if(!res.ok){
        const msg = (data && (data.message||data.error||data.details)) ? (data.message||data.error||data.details) : "Error Supabase.";
        throw new Error(msg);
      }
      return data;
    }

    let lastTouchAt = 0;
    async function touchSession(force=false){
      const now = Date.now();
      if(!force && (now-lastTouchAt)<60_000) return true;
      lastTouchAt = now;
      const s = getSession();
      if(!s.token) return false;
      const rows = await callRpc(RPC.touch,{ p_session_token:s.token });
      return Array.isArray(rows) && rows.length>0;
    }

    async function logoutAndGoLogin(){
      try{
        const s=getSession();
        if(s.token) await callRpc(RPC.logout,{ p_session_token:s.token });
      }catch(_){}
      ["dp_session_token","dp_role","dp_display_name","dp_user_id","dp_expires_at","dp_last_activity"].forEach(k=>localStorage.removeItem(k));
      window.location.href = ROUTES.login;
    }

    function startIdleWatcher(){
      setInterval(async ()=>{
        const last = localStorage.getItem("dp_last_activity");
        if(!last) return;
        if(Date.now() - new Date(last).getTime() > IDLE_MS){
          alert("Sesión cerrada por inactividad (30 min).");
          await logoutAndGoLogin();
        }
      }, 30_000);
    }

    /***********************
     * Cart (local hasta confirmar)
     ***********************/
    const cart = new Map(); // barcode -> { barcode, name, qty }
    const lookupCache = new Map(); // barcode -> {name, active}

    function cartTotals(){
      let items = 0, units = 0;
      cart.forEach(v=>{ items += 1; units += Number(v.qty||0); });
      el("items_count").textContent = String(items);
      el("units_total").textContent = String(units);
      el("btn_confirm").disabled = (items === 0);
    }

    function renderCart(){
      const tb = el("tbody");
      tb.innerHTML = "";
      if(cart.size === 0){
        tb.innerHTML = `<tr><td colspan="4" class="text-center text-muted py-4">Escanea un barcode para iniciar.</td></tr>`;
        cartTotals();
        return;
      }

      [...cart.values()].sort((a,b)=> (a.name||"").localeCompare(b.name||"","es")).forEach(row=>{
        const tr = document.createElement("tr");
        tr.innerHTML = `
          <td class="mono">${esc(row.qty)}</td>
          <td class="fw-semibold">${esc(row.name)}</td>
          <td class="mono">${esc(row.barcode)}</td>
          <td class="text-end">
            <button class="btn btn-outline-danger btn-sm" data-bc="${esc(row.barcode)}">Quitar</button>
          </td>
        `;
        tb.appendChild(tr);
      });

      tb.querySelectorAll('button[data-bc]').forEach(b=>{
        b.addEventListener("click", ()=>{
          const bc = b.getAttribute("data-bc");
          cart.delete(bc);
          renderCart();
        });
      });

      cartTotals();
    }

    /***********************
     * Lookup (pharma_catalog)
     ***********************/
    function setLookupUI(state){
      // state: {name, active, ok, msg}
      el("lookup_name").textContent = state.name || "—";
      el("lookup_state").innerHTML = state.msg || "";
      el("btn_add").disabled = !state.ok;
    }

    async function lookupBarcode(barcode){
      hideAlert("alert_main");
      hideAlert("alert_ok");

      const bc = normalizeDigits(barcode);
      if(!bc){
        setLookupUI({ ok:false, name:"—", msg:"" });
        return;
      }

      // cache primero
      if(lookupCache.has(bc)){
        const c = lookupCache.get(bc);
        if(!c.active){
          setLookupUI({ ok:false, name:c.name, msg:`<span class="badge text-bg-secondary ms-2">Inactivo</span>` });
        }else{
          setLookupUI({ ok:true, name:c.name, msg:`<span class="badge text-bg-success ms-2">OK</span>` });
        }
        return;
      }

      const ok = await touchSession(true);
      if(!ok) return logoutAndGoLogin();

      const s = getSession();
      try{
        const rows = await callRpc(RPC.pharmaLookup, { p_session_token:s.token, p_barcode:bc });
        const r = Array.isArray(rows) && rows.length ? rows[0] : null;

        if(!r){
          setLookupUI({
            ok:false,
            name:"No identificado",
            msg:`<span class="badge text-bg-warning ms-2">No existe en catálogo</span>`
          });
          return;
        }

        lookupCache.set(bc, { name:r.product_name, active:!!r.active });

        if(!r.active){
          setLookupUI({ ok:false, name:r.product_name, msg:`<span class="badge text-bg-secondary ms-2">Inactivo</span>` });
        }else{
          setLookupUI({ ok:true, name:r.product_name, msg:`<span class="badge text-bg-success ms-2">OK</span>` });
        }
      } catch(err){
        showAlert("alert_main", err.message || "No se pudo consultar el catálogo.");
        setLookupUI({ ok:false, name:"—", msg:"" });
      }
    }

    /***********************
     * Actions
     ***********************/
    function clearInputs(keepExpediente=true){
      if(!keepExpediente) el("expediente").value = "";
      el("barcode").value = "";
      el("qty").value = "1";
      setLookupUI({ ok:false, name:"—", msg:"" });
      el("barcode").focus();
    }

    function addToCart(){
      hideAlert("alert_main");
      hideAlert("alert_cart");
      hideAlert("alert_ok");

      const exp = normalizeDigits(el("expediente").value);
      if(!exp){
        showAlert("alert_main","Expediente requerido (numérico).");
        el("expediente").focus();
        return;
      }

      const bc = normalizeDigits(el("barcode").value);
      if(!bc){
        showAlert("alert_main","Barcode requerido.");
        el("barcode").focus();
        return;
      }

      const qty = Math.max(1, parseInt(normalizeDigits(el("qty").value) || "1", 10));
      const cached = lookupCache.get(bc);

      if(!cached || !cached.active){
        showAlert("alert_main", "Este barcode no está activo/en catálogo. Solicita al administrador.");
        return;
      }

      if(cart.has(bc)){
        const row = cart.get(bc);
        row.qty = Number(row.qty) + qty;
        cart.set(bc, row);
      } else {
        cart.set(bc, { barcode: bc, name: cached.name, qty });
      }

      renderCart();
      clearInputs(true);
    }

    async function confirmDispatch(){
      hideAlert("alert_main");
      hideAlert("alert_cart");
      hideAlert("alert_ok");

      const ok = await touchSession(true);
      if(!ok) return logoutAndGoLogin();

      const s = getSession();
      const exp = normalizeDigits(el("expediente").value);
      if(!exp) return showAlert("alert_main","Expediente requerido (numérico).");

      if(cart.size === 0) return showAlert("alert_cart","Carrito vacío.");

      try{
        btnLoad("btn_confirm","btn_confirm_text","btn_confirm_spinner", true, "Confirmando…", "Confirmar despacho");

        // 1) Crear dispatch
        const created = await callRpc(RPC.dispatchCreate, { p_session_token:s.token, p_expediente: exp });
        const dispatch_id = (Array.isArray(created) && created.length) ? created[0].dispatch_id : null;
        if(!dispatch_id) throw new Error("No se pudo crear el despacho (dispatch_id vacío).");

        // 2) Agregar items
        for(const row of cart.values()){
          await callRpc(RPC.dispatchAddItem, {
            p_session_token: s.token,
            p_dispatch_id: dispatch_id,
            p_barcode: row.barcode,
            p_qty: Number(row.qty)
          });
        }

        // 3) Confirmar (genera delivery_no)
        const conf = await callRpc(RPC.dispatchConfirm, { p_session_token:s.token, p_dispatch_id: dispatch_id });
        const delivery_no = (Array.isArray(conf) && conf.length) ? (conf[0].delivery_no ?? null) : null;

        cart.clear();
        renderCart();

        showAlert("alert_ok", `Despacho confirmado${delivery_no ? " | Entrega #"+delivery_no : ""}.`);
        clearInputs(false); // limpia expediente también
      } catch(err){
        showAlert("alert_main", err.message || "No se pudo confirmar el despacho.");
      } finally {
        btnLoad("btn_confirm","btn_confirm_text","btn_confirm_spinner", false, "Confirmando…", "Confirmar despacho");
      }
    }

    /***********************
     * INIT
     ***********************/
    (async function init(){
      const s = getSession();
      if(!s.token) return window.location.href = ROUTES.login;

      // Gate de rol
      if(s.role !== "dispatch"){
        if(s.role==="admin") return window.location.href = ROUTES.catalog; // admin cae al catálogo
        if(s.role==="cashier") return window.location.href = ROUTES.cashier;
        return window.location.href = ROUTES.login;
      }

      el("nav_user").textContent = s.name || "—";

      setLastActivity();
      ["mousemove","mousedown","keydown","touchstart","wheel"].forEach(ev =>
        window.addEventListener(ev, ()=>setLastActivity(), { passive:true })
      );
      startIdleWatcher();

      el("btn_logout").addEventListener("click", async ()=>{
        if(!confirm("¿Cerrar sesión?")) return;
        await logoutAndGoLogin();
      });

      // Inputs normalize
      el("expediente").addEventListener("input",(e)=>{ e.target.value = normalizeDigits(e.target.value); });
      el("qty").addEventListener("input",(e)=>{ e.target.value = normalizeDigits(e.target.value); });

      el("barcode").addEventListener("input",(e)=>{
        e.target.value = normalizeDigits(e.target.value);
        // Lookup suave (debounce corto)
        const v = e.target.value;
        window.clearTimeout(window.__lk);
        window.__lk = window.setTimeout(()=>lookupBarcode(v), 120);
      });

      el("barcode").addEventListener("keydown",(e)=>{
        if(e.key==="Enter"){
          e.preventDefault();
          addToCart();
        }
      });

      el("qty").addEventListener("keydown",(e)=>{
        if(e.key==="Enter"){
          e.preventDefault();
          addToCart();
        }
      });

      el("btn_add").addEventListener("click", async ()=>{
        btnLoad("btn_add","btn_add_text","btn_add_spinner", true, "Agregando…", "Agregar");
        try{ addToCart(); }
        finally{ btnLoad("btn_add","btn_add_text","btn_add_spinner", false, "Agregando…", "Agregar"); }
      });

      el("btn_clear").addEventListener("click", ()=>{
        if(cart.size>0 && !confirm("¿Limpiar inputs? (El carrito se mantiene)")) return;
        clearInputs(true);
      });

      el("btn_confirm").addEventListener("click", confirmDispatch);

      // Estado inicial
      setLookupUI({ ok:false, name:"—", msg:"" });
      renderCart();
      el("expediente").focus();
    })();
  </script>
</body>
</html>
