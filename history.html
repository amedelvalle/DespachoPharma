<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>DespachoPharma | Histórico</title>

  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">

  <style>
    :root{
      --bg:#f8fafc;
      --card:#ffffff;
      --border:#e2e8f0;
      --text:#0f172a;
      --muted:#64748b;
    }
    body{ background:var(--bg); color:var(--text); }
    .app-card{
      background:var(--card);
      border:1px solid var(--border);
      border-radius:16px;
      box-shadow: 0 6px 20px rgba(15,23,42,.06);
    }
    .brand-dot{ width:10px;height:10px;border-radius:999px;background:#3b82f6;display:inline-block;margin-right:8px; }
    .mono{ font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono","Courier New", monospace; }
    .table td, .table th { vertical-align: middle; }
  </style>
</head>

<body>
  <nav class="navbar navbar-expand-lg bg-white border-bottom">
    <div class="container">
      <a class="navbar-brand d-flex align-items-center" href="#">
        <span class="brand-dot"></span>
        <span class="fw-semibold">DespachoPharma</span>
      </a>

      <div class="ms-auto d-flex align-items-center gap-2">
        <span class="badge text-bg-light border">
          <span class="text-muted">Usuario:</span>
          <span id="nav_user" class="ms-1 fw-semibold">—</span>
        </span>
        <span class="badge text-bg-light border">
          <span class="text-muted">Rol:</span>
          <span class="ms-1 fw-semibold">Admin/Consulta</span>
        </span>
        <button id="btn_logout" class="btn btn-outline-secondary btn-sm">Salir</button>
      </div>
    </div>
  </nav>

  <main class="container py-4">
    <div class="row g-3">
      <div class="col-12 col-lg-4">
        <div class="app-card p-3">
          <div class="fw-semibold">Filtros</div>
          <div class="text-muted small">Busca por fecha/estado/expediente/entrega.</div>

          <div id="alert_filters" class="alert alert-danger d-none mt-3 mb-0" role="alert"></div>

          <div class="row g-2 mt-2">
            <div class="col-6">
              <label class="form-label" for="date_from">Desde</label>
              <input id="date_from" type="date" class="form-control" />
            </div>
            <div class="col-6">
              <label class="form-label" for="date_to">Hasta</label>
              <input id="date_to" type="date" class="form-control" />
            </div>

            <div class="col-12">
              <label class="form-label" for="status">Estado</label>
              <select id="status" class="form-select">
                <option value="" selected>Todos</option>
                <option value="draft">Draft</option>
                <option value="confirmed">Confirmed (pendiente caja)</option>
                <option value="validated">Validated</option>
                <option value="observed">Observed</option>
                <option value="voided">Voided</option>
              </select>
            </div>

            <div class="col-6">
              <label class="form-label" for="expediente">Expediente</label>
              <input id="expediente" class="form-control" inputmode="numeric" placeholder="Ej: 123456" />
            </div>
            <div class="col-6">
              <label class="form-label" for="delivery_no">Entrega #</label>
              <input id="delivery_no" class="form-control" inputmode="numeric" placeholder="Ej: 3" />
            </div>

            <div class="col-12">
              <label class="form-label" for="created_by_name">Despachador (texto)</label>
              <input id="created_by_name" class="form-control" placeholder="Ej: Despacho 1" />
              <div class="form-text">Filtro local por nombre (post-búsqueda).</div>
            </div>
          </div>

          <div class="d-flex flex-wrap gap-2 mt-3">
            <button id="btn_today" class="btn btn-outline-secondary btn-sm">Hoy</button>
            <button id="btn_7d" class="btn btn-outline-secondary btn-sm">Últimos 7 días</button>
          </div>

          <div class="d-grid gap-2 mt-3">
            <button id="btn_search" class="btn btn-primary">
              <span id="btn_search_text">Buscar</span>
              <span id="btn_search_spinner" class="spinner-border spinner-border-sm ms-2 d-none"></span>
            </button>
          </div>

          <div class="small text-muted mt-3">
            Sesión: se cerrará tras 30 min sin uso.
          </div>
        </div>
      </div>

      <div class="col-12 col-lg-8">
        <div class="app-card p-3">
          <div class="d-flex flex-wrap gap-2 justify-content-between align-items-start">
            <div>
              <div class="fw-semibold">Resultados</div>
              <div class="text-muted small">Click en “Ver” para abrir el detalle.</div>
            </div>
            <div class="text-end">
              <div class="text-muted small">Resumen (Vista actual)</div>
              <div>
                <span id="count_results" class="fw-semibold">0</span> regs | 
                <span class="fw-semibold text-primary"><span id="sum_units">0</span> Unds</span>
              </div>
            </div>
          </div>

          <div id="alert_results" class="alert alert-danger d-none mt-3 mb-0" role="alert"></div>

          <div class="table-responsive mt-3">
            <table class="table table-sm align-middle">
              <thead class="table-light">
                <tr>
                  <th style="width:10%">Entrega</th>
                  <th style="width:18%">Expediente</th>
                  <th style="width:22%">Fecha</th>
                  <th style="width:12%" class="text-center">Unid.</th>
                  <th style="width:18%">Estado</th>
                  <th style="width:20%">Despachador</th>
                  <th style="width:10%" class="text-end">Acción</th>
                </tr>
              </thead>
              <tbody id="results_body">
                <tr><td colspan="7" class="text-center text-muted py-4">Busca para ver resultados.</td></tr>
              </tbody>
            </table>
          </div>

          <div class="d-flex justify-content-end gap-2">
            <button id="btn_prev" class="btn btn-outline-secondary btn-sm" disabled>Anterior</button>
            <button id="btn_next" class="btn btn-outline-secondary btn-sm" disabled>Siguiente</button>
          </div>
        </div>
      </div>
    </div>
  </main>

  <div class="modal fade" id="modal_detail" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-lg modal-dialog-scrollable">
      <div class="modal-content">
        <div class="modal-header">
          <div>
            <h5 class="modal-title mb-0">Detalle</h5>
            <div class="small text-muted">
              <span class="me-2">Entrega <span id="m_delivery" class="fw-semibold">—</span></span>
              <span class="me-2">Exp <span id="m_exp" class="fw-semibold">—</span></span>
              <span id="m_status_badge" class="badge text-bg-secondary">—</span>
            </div>
          </div>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Cerrar"></button>
        </div>

        <div class="modal-body">
          <div id="alert_modal" class="alert alert-danger d-none" role="alert"></div>

          <div class="d-flex flex-wrap gap-2 mb-3">
            <span class="badge text-bg-light border">
              Unidades: <span id="m_units" class="fw-semibold">0</span>
            </span>
            <span class="badge text-bg-light border">
              Ítems: <span id="m_items" class="fw-semibold">0</span>
            </span>
            <span class="badge text-bg-light border">
              Despachador: <span id="m_dispatcher" class="fw-semibold">—</span>
            </span>
            <span class="badge text-bg-light border">
              Confirmado: <span id="m_confirmed_at" class="fw-semibold">—</span>
            </span>
            <span class="badge text-bg-light border">
              Validado: <span id="m_validated_at" class="fw-semibold">—</span>
            </span>
            <span class="badge text-bg-light border">
              Observado: <span id="m_observed_at" class="fw-semibold">—</span>
            </span>
          </div>

          <div class="table-responsive">
            <table class="table table-sm">
              <thead class="table-light">
                <tr>
                  <th>Producto</th>
                  <th class="text-center">Cantidad</th>
                </tr>
              </thead>
              <tbody id="m_items_body"></tbody>
            </table>
          </div>

          <div id="m_note_block" class="alert alert-warning d-none mt-3 mb-0"></div>
        </div>

        <div class="modal-footer">
          <button class="btn btn-outline-secondary" data-bs-dismiss="modal">Cerrar</button>
        </div>
      </div>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>

  <script>
    /***********************
     * CONFIG
     ***********************/
    const SUPABASE_URL = "https://rewdmcyqxyzcoeiikoow.supabase.co";
    const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InJld2RtY3lxeHl6Y29laWlrb293Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzEwMDcxMDMsImV4cCI6MjA4NjU4MzEwM30.vRkCRFYez3zeL67Ik_niDrPu9wGt53gEqE6LLf_SUHE";
    const ROUTES = { login: "index.html", dispatch: "dispatch.html", cashier: "cashier.html" };

    /***********************/
    const el = (id) => document.getElementById(id);

    function showAlert(id, msg){ const a = el(id); a.textContent = msg; a.classList.remove("d-none"); }
    function hideAlert(id){ const a = el(id); a.textContent = ""; a.classList.add("d-none"); }

    function getSession(){
      return {
        token: localStorage.getItem("dp_session_token") || "",
        role: (localStorage.getItem("dp_role") || "").toLowerCase(),
        name: localStorage.getItem("dp_display_name") || ""
      };
    }

    function setLastActivity(){ localStorage.setItem("dp_last_activity", new Date().toISOString()); }

    let lastTouchAt = 0;
    async function touchSession(force=false){
      const now = Date.now();
      if (!force && (now - lastTouchAt) < 60_000) return true;
      lastTouchAt = now;

      const { token } = getSession();
      if (!token) return false;
      const rows = await callRpc("rpc_session_touch", { p_session_token: token });
      return (Array.isArray(rows) && rows.length > 0);
    }

    async function logoutAndGoLogin(){
      try{
        const { token } = getSession();
        if (token) await callRpc("rpc_logout", { p_session_token: token });
      } catch(_){}
      ["dp_session_token","dp_role","dp_display_name","dp_user_id","dp_expires_at","dp_last_activity"].forEach(k => localStorage.removeItem(k));
      window.location.href = ROUTES.login;
    }

    async function callRpc(fnName, body){
      const url = `${SUPABASE_URL}/rest/v1/rpc/${fnName}`;
      const res = await fetch(url, {
        method: "POST",
        headers: {
          "Content-Type": "application/json",
          "apikey": SUPABASE_ANON_KEY,
          "Authorization": `Bearer ${SUPABASE_ANON_KEY}`
        },
        body: JSON.stringify(body || {})
      });
      const text = await res.text();
      let data = null;
      try { data = text ? JSON.parse(text) : null; } catch { data = null; }
      if (!res.ok){
        const msg = (data && (data.message || data.error || data.details)) ?
          (data.message || data.error || data.details) : "Error de conexión con Supabase.";
        throw new Error(msg);
      }
      return data;
    }

    function setBtnLoading(btnId, textId, spinnerId, isLoading, loadingText, normalText){
      const btn = el(btnId);
      if(btn) btn.disabled = isLoading;
      const spin = el(spinnerId);
      if(spin) spin.classList.toggle("d-none", !isLoading);
      const txt = el(textId);
      if(txt) txt.textContent = isLoading ? loadingText : normalText;
    }

    function sanitizeDigits(v){ return (v || "").replace(/\D/g, ""); }

    function setDefaultDatesLast7(){
      const now = new Date();
      const to = new Date(now);
      const from = new Date(now);
      from.setDate(from.getDate() - 6);

      el("date_from").value = toYmd(from);
      el("date_to").value = toYmd(to);
    }

    function setDefaultDatesToday(){
      const now = new Date();
      el("date_from").value = toYmd(now);
      el("date_to").value = toYmd(now);
    }

    function toYmd(d){
      const y = d.getFullYear();
      const m = String(d.getMonth()+1).padStart(2,"0");
      const day = String(d.getDate()).padStart(2,"0");
      return `${y}-${m}-${day}`;
    }

    function isoFromDateInput(dateStr, endOfDay=false){
      if (!dateStr) return null;
      const [y,m,d] = dateStr.split("-").map(Number);
      const dt = new Date(y, (m-1), d, endOfDay ? 23 : 0, endOfDay ? 59 : 0, endOfDay ? 59 : 0, endOfDay ? 999 : 0);
      return dt.toISOString();
    }

    function fmtTime(ts){
      if (!ts) return "—";
      const d = new Date(ts);
      return d.toLocaleString(undefined, { year:"numeric", month:"2-digit", day:"2-digit", hour:"2-digit", minute:"2-digit" });
    }

    function escapeHtml(str){
      return String(str ?? "").replace(/[&<>"']/g, (m) => ({
        "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#039;"
      }[m]));
    }

    function statusBadgeHtml(status){
      if (status === "validated") return `<span class="badge text-bg-success">Validated</span>`;
      if (status === "observed") return `<span class="badge text-bg-warning text-dark">Observed</span>`;
      if (status === "confirmed") return `<span class="badge text-bg-primary">Confirmed</span>`;
      if (status === "draft") return `<span class="badge text-bg-secondary">Draft</span>`;
      if (status === "voided") return `<span class="badge text-bg-danger">Voided</span>`;
      return `<span class="badge text-bg-light border">—</span>`;
    }

    /***********************
     * PAGINATION & SEARCH
     ***********************/
    let pageOffset = 0;
    const PAGE_LIMIT = 50;
    let lastFetchedCount = 0; // Cantidad REAL traída de BD, no la filtrada

    async function search(){
      hideAlert("alert_filters");
      hideAlert("alert_results");
      
      const { token } = getSession();
      const ok = await touchSession(true);
      if (!ok) return logoutAndGoLogin();

      const fromIso = isoFromDateInput(el("date_from").value, false);
      const toIso = isoFromDateInput(el("date_to").value, true);

      const status = el("status").value || null;
      const expediente = sanitizeDigits(el("expediente").value).slice(0, 30) || null;
      const deliveryNo = Number(sanitizeDigits(el("delivery_no").value)) || null;

      try {
        setBtnLoading("btn_search","btn_search_text","btn_search_spinner", true, "Buscando…", "Buscar");
        
        const rows = await callRpc("rpc_dispatch_search", {
            p_session_token: token,
            p_date_from: fromIso,
            p_date_to: toIso,
            p_status: status,
            p_expediente: expediente,
            p_delivery_no: deliveryNo,
            p_created_by: null,
            p_limit: PAGE_LIMIT,
            p_offset: pageOffset
        });

        // 1. Guardamos cuántos trajo realmente la BD para la paginación
        lastFetchedCount = Array.isArray(rows) ? rows.length : 0;

        // 2. Filtramos localmente por nombre
        const nameFilter = (el("created_by_name").value || "").trim().toLowerCase();
        let filtered = Array.isArray(rows) ? rows : [];
        
        if (nameFilter){
            filtered = filtered.filter(r => String(r.created_by_name || "").toLowerCase().includes(nameFilter));
        }

        renderResults(filtered);

        // 3. Control de botones
        el("btn_prev").disabled = (pageOffset <= 0);
        // Validamos contra las filas crudas de la BD
        el("btn_next").disabled = (lastFetchedCount < PAGE_LIMIT);

      } catch(err){
          showAlert("alert_results", err.message || "No se pudieron cargar resultados.");
      } finally {
          setBtnLoading("btn_search","btn_search_text","btn_search_spinner", false, "Buscando…", "Buscar");
      }
    }

    function renderResults(rows){
      el("count_results").textContent = String(rows.length);

      // AQUI ESTÁ EL CALCULO DE LA SUMA
      const totalUnits = rows.reduce((acc, r) => acc + (Number(r.total_units) || 0), 0);
      const sumSpan = el("sum_units");
      if(sumSpan) sumSpan.textContent = String(totalUnits);

      const body = el("results_body");
      body.innerHTML = "";

      if (!rows.length){
        body.innerHTML = `<tr><td colspan="7" class="text-center text-muted py-4">Sin resultados (con los filtros actuales).</td></tr>`;
        return;
      }

      rows.forEach(r => {
        const tr = document.createElement("tr");
        tr.innerHTML = `
          <td class="mono fw-semibold">#${Number(r.delivery_no || 0)}</td>
          <td class="fw-semibold">${escapeHtml(r.expediente || "")}</td>
          <td class="text-muted">${escapeHtml(fmtTime(r.confirmed_at || r.created_at))}</td>
          <td class="text-center fw-semibold">${Number(r.total_units || 0)}</td>
          <td>${statusBadgeHtml(r.status)}</td>
          <td>${escapeHtml(r.created_by_name || "—")}</td>
          <td class="text-end">
            <button class="btn btn-outline-secondary btn-sm" data-action="view" data-delivery="${Number(r.delivery_no || 0)}">Ver</button>
          </td>
        `;
        body.appendChild(tr);
      });

      body.querySelectorAll('button[data-action="view"]').forEach(btn => {
        btn.addEventListener("click", async () => {
          const delivery = Number(btn.getAttribute("data-delivery"));
          if (delivery) await openDetailByDeliveryNo(delivery);
        });
      });
    }

    function setModalStatus(status){
      const b = el("m_status_badge");
      b.className = "badge";
      if (status === "confirmed") { b.classList.add("text-bg-primary"); b.textContent = "Confirmed"; }
      else if (status === "validated") { b.classList.add("text-bg-success"); b.textContent = "Validated"; }
      else if (status === "observed") { b.classList.add("text-bg-warning","text-dark"); b.textContent = "Observed"; }
      else if (status === "draft") { b.classList.add("text-bg-secondary"); b.textContent = "Draft"; }
      else if (status === "voided") { b.classList.add("text-bg-danger"); b.textContent = "Voided"; }
      else { b.classList.add("text-bg-light","border"); b.textContent = status || "—"; }
    }

    async function openDetailByDeliveryNo(deliveryNo){
      hideAlert("alert_modal");
      el("m_items_body").innerHTML = "";
      el("m_note_block").classList.add("d-none");
      el("m_note_block").textContent = "";

      const { token } = getSession();
      const ok = await touchSession(true);
      if (!ok) return logoutAndGoLogin();

      try {
        const rows = await callRpc("rpc_dispatch_get_by_delivery_no", { p_session_token: token, p_delivery_no: Number(deliveryNo) });
        if (!Array.isArray(rows) || rows.length === 0){
            showAlert("alert_results", "No se pudo abrir el detalle.");
            return;
        }

        const header = rows[0].header || {};
        const items = Array.isArray(rows[0].items) ? rows[0].items : [];

        el("m_delivery").textContent = header.delivery_no ? `#${header.delivery_no}` : "—";
        el("m_exp").textContent = header.expediente || "—";
        setModalStatus(header.status);

        el("m_units").textContent = String(header.total_units ?? 0);
        el("m_items").textContent = String(header.items_count ?? items.length ?? 0);
        el("m_dispatcher").textContent = header.created_by_name || "—";
        el("m_confirmed_at").textContent = header.confirmed_at ? fmtTime(header.confirmed_at) : "—";
        el("m_validated_at").textContent = header.validated_at ? fmtTime(header.validated_at) : "—";
        el("m_observed_at").textContent = header.observed_at ? fmtTime(header.observed_at) : "—";

        const tb = el("m_items_body");
        tb.innerHTML = "";
        items.forEach(it => {
            const tr = document.createElement("tr");
            tr.innerHTML = `
            <td>
                <div class="fw-semibold">${escapeHtml(it.product_name || "—")}</div>
                <div class="small text-muted mono">${escapeHtml(it.barcode || "")}</div>
            </td>
            <td class="text-center fw-semibold">${Number(it.qty || 0)}</td>
            `;
            tb.appendChild(tr);
        });

        if (header.observation_note){
            el("m_note_block").textContent = `Observación: ${header.observation_note}`;
            el("m_note_block").classList.remove("d-none");
        }

        bootstrap.Modal.getOrCreateInstance(el("modal_detail")).show();
      } catch(e) {
         showAlert("alert_results", "Error cargando detalle.");
      }
    }

    /***********************
     * IDLE LOGIC (30 min)
     ***********************/
    const IDLE_MINUTES = 30;
    const IDLE_MS = IDLE_MINUTES * 60 * 1000;

    function wireActivityEvents(){
      const events = ["mousemove","mousedown","keydown","touchstart","wheel"];
      events.forEach(ev => window.addEventListener(ev, () => setLastActivity(), { passive: true }));
    }

    function startIdleWatcher(){
      setInterval(async () => {
        const last = localStorage.getItem("dp_last_activity");
        if (!last) return;
        const diff = Date.now() - new Date(last).getTime();
        if (diff > IDLE_MS){
          alert("Sesión cerrada por inactividad (30 min).");
          await logoutAndGoLogin();
        }
      }, 30_000);
    }

    /***********************
     * INIT
     ***********************/
    (async function init(){
      const s = getSession();
      if (!s.token) return window.location.href = ROUTES.login;

      // Role gate
      if (s.role !== "admin"){
        if (s.role === "dispatch") return window.location.href = ROUTES.dispatch;
        if (s.role === "cashier") return window.location.href = ROUTES.cashier;
        return window.location.href = ROUTES.login;
      }

      el("nav_user").textContent = s.name || "—";
      setLastActivity();
      wireActivityEvents();
      startIdleWatcher();

      // defaults
      setDefaultDatesLast7();

      el("expediente").addEventListener("input", (e) => e.target.value = sanitizeDigits(e.target.value).slice(0, 30));
      el("delivery_no").addEventListener("input", (e) => e.target.value = sanitizeDigits(e.target.value).slice(0, 12));
      
      // Auto-search para botones
      el("btn_today").addEventListener("click", async () => { 
        setDefaultDatesToday(); 
        pageOffset = 0;
        await search();
      });
      el("btn_7d").addEventListener("click", async () => { 
        setDefaultDatesLast7(); 
        pageOffset = 0;
        await search();
      });

      el("btn_search").addEventListener("click", async () => {
        pageOffset = 0;
        await search();
      });

      el("btn_prev").addEventListener("click", async () => {
        if (pageOffset <= 0) return;
        pageOffset = Math.max(0, pageOffset - PAGE_LIMIT);
        await search();
      });

      el("btn_next").addEventListener("click", async () => {
        if (lastFetchedCount < PAGE_LIMIT) return;
        pageOffset += PAGE_LIMIT;
        await search();
      });

      el("btn_logout").addEventListener("click", async () => {
        if (!confirm("¿Cerrar sesión?")) return;
        await logoutAndGoLogin();
      });

      // auto-search inicial
      try{
        await search();
      } catch(_){}
    })();
  </script>
</body>
</html>
